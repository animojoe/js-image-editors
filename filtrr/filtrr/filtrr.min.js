/*
 * Copyright 2011 (c) Alexandros Michael - Licenced under the GNU GPL.
 */

var filtr=function(s){if(!s){throw"Canvas supplied to filtr was null or undefined.";}var u=s;var w=u.width;var h=u.height;var v=u.getContext("2d");var x=v.getImageData(0,0,w,h);var y=function(i){return Math.min(255,Math.max(0,i))};this.duplicate=function(){return new filtr(u)};this.put=function(){v.putImageData(x,0,0)};this.canvas=function(){return u};this.getCurrentImageData=function(){return x};this.core={apply:function(a){var b=x.data;var i=0,j=0;for(i=0;i<h;i++){for(j=0;j<w;j++){var c=(i*w*4)+(j*4);var d=a(b[c],b[c+1],b[c+2],b[c+3]);b[c]=d.r;b[c+1]=d.g;b[c+2]=d.b;b[c+3]=d.a}}return this},convolve:function(a){if(!a){throw"Kernel was null in convolve function.";}else if(a.length===0){throw"Kernel length was 0 in convolve function.";}var c=x;if(!v.createImageData){throw"createImageData is not supported."}var d=v.createImageData(c.width,c.height);var e=d.data;var k=x.data;var l=parseInt(a.length/2);var o=parseInt(a[0].length/2);var i=0,j=0,n=0,m=0;for(i=0;i<h;i++){for(j=0;j<w;j++){var p=(i*w*4)+(j*4);var r=0,g=0,b=0;for(n=-l;n<=l;n++){for(m=-o;m<=o;m++){if(i+n>=0&&i+n<h){if(j+m>=0&&j+m<w){var f=a[n+l][m+o];if(f===0){continue}var q=((i+n)*w*4)+((j+m)*4);r+=k[q]*f;g+=k[q+1]*f;b+=k[q+2]*f}}}}e[p]=y(r);e[p+1]=y(g);e[p+2]=y(b);e[p+3]=255}}return d},edgeDetection:function(a){var b=x;var c=x.data;var i=0,j=0,index=0;if(a.toLowerCase()==="simple"){if(!v.createImageData){throw"createImageData is not supported.";}var d=v.createImageData(b.width,b.height);var e=d.data;for(i=0;i<h;i++){for(j=1;j<w;j++){index=(i*w*4)+(j*4);var f=(i*w*4)+((j-1)*4);e[index]=y(Math.abs(c[index]-c[f]));e[index+1]=y(Math.abs(c[index+1]-c[f+1]));e[index+2]=y(Math.abs(c[index+2]-c[f+2]));e[index+3]=255}}x=d}else if(a.toLowerCase()==="sobel"){var g=this.convolve([[-1.0,-2.0,-1.0],[0.0,0.0,0.0],[1.0,2.0,1.0]]);var k=this.convolve([[-1.0,0.0,1.0],[-2.0,0.0,2.0],[-1.0,0.0,1.0]]);var l=g.data;var m=k.data;for(i=0;i<h;i++){for(j=0;j<w;j++){index=(i*w*4)+(j*4);var n=l[index],rV=m[index],grH=l[index+1],grV=m[index+1],bH=l[index+2],bV=m[index+2];c[index]=Math.sqrt(n*n+rV*rV);c[index+1]=Math.sqrt(grH*grH+grV*grV);c[index+2]=Math.sqrt(bH*bH+bV*bV)}}x=b}else if(a.toLowerCase()==="canny"){}return this},adjust:function(c,d,e){this.apply(function(r,g,b,a){return{r:y(r*(1+c)),g:y(g*(1+d)),b:y(b*(1+e)),a:a}});c=d=e=null;return this},brightness:function(t){this.apply(function(r,g,b,a){return{r:y(r+t),g:y(g+t),b:y(b+t),a:a}});t=null;return this},fill:function(c,d,e){this.apply(function(r,g,b,a){return{r:y(c),g:y(d),b:y(e),a:a}});rf=d=e=null;return this},opacity:function(o){this.apply(function(r,g,b,a){return{r:r,g:g,b:b,a:y(o*a)}});o=null;return this},saturation:function(t){this.apply(function(r,g,b,a){var c=(r+g+b)/3;return{r:y(c+t*(r-c)),g:y(c+t*(g-c)),b:y(c+t*(b-c)),a:a}});t=null;return this},threshold:function(t){this.apply(function(r,g,b,a){var c=255;if(r<t||g<t||b<t){c=0}return{r:c,g:c,b:c,a:a}});t=null;return this},posterize:function(c){var d=Math.floor(255/c);this.apply(function(r,g,b,a){return{r:y(Math.floor(r/d)*d),g:y(Math.floor(g/d)*d),b:y(Math.floor(b/d)*d),a:a}});d=null;c=null;return this},gamma:function(c){this.apply(function(r,g,b,a){return{r:y(Math.pow(r,c)),g:y(Math.pow(g,c)),b:y(Math.pow(b,c)),a:a}});c=null;return this},negative:function(){this.apply(function(r,g,b,a){return{r:y(255-r),g:y(255-g),b:y(255-b),a:a}});return this},grayScale:function(){this.apply(function(r,g,b,a){var c=(r+g+b)/3;return{r:y(c),g:y(c),b:y(c),a:a}});return this},bump:function(){x=this.convolve([[-1.0,-1.0,0.0],[-1.0,1.0,1.0],[0.0,1.0,1.0]]);return this},tint:function(c,d){this.apply(function(r,g,b,a){return{r:y((r-c[0])*((255/(d[0]-c[0])))),g:y((g-c[1])*((255/(d[1]-c[1])))),b:y((b-c[2])*((255/(d[2]-c[2])))),a:a}});c=d=null;return this},mask:function(c,d,e){this.apply(function(r,g,b,a){return{r:y(r&c),g:y(g&d),b:y(b&e),a:a}});c=d=e=null;return this},sepia:function(){this.apply(function(r,g,b,a){return{r:y((r*0.393)+(g*0.769)+(b*0.189)),g:y((r*0.349)+(g*0.686)+(b*0.168)),b:y((r*0.272)+(g*0.534)+(b*0.131)),a:a}});return this},bias:function(c){function calc(f,a){return f/((1.0/a-1.9)*(0.9-f)+1)}this.apply(function(r,g,b,a){return{r:y(r*calc(r/255,c)),g:y(g*calc(g/255,c)),b:y(b*calc(b/255,c)),a:a}});c=null;return this},contrast:function(d){function calc(f,c){return(f-0.5)*c+0.5}this.apply(function(r,g,b,a){return{r:y(255*calc(r/255,d)),g:y(255*calc(g/255,d)),b:y(255*calc(b/255,d)),a:a}});d=null;return this},blur:function(){x=this.convolve([[1,2,1],[2,2,2],[1,2,1]]);return this},sharpen:function(){x=this.convolve([[0.0,-0.2,0.0],[-0.2,1.8,-0.2],[0.0,-0.2,0.0]]);return this},gaussianBlur:function(){x=this.convolve([[1/273,4/273,7/273,4/273,1/273],[4/273,16/273,26/273,16/273,4/273],[7/273,26/273,41/273,26/273,7/273],[4/273,16/273,26/273,16/273,4/273],[1/273,4/273,7/273,4/273,1/273]]);return this}};this.blend={apply:function(a,b){var c=a.getCurrentImageData();var d=c.data;var e=x.data;var i=0,j=0;for(i=0;i<h;i++){for(j=0;j<w;j++){var f=(i*w*4)+(j*4);var g=b({r:d[f],g:d[f+1],b:d[f+2],a:d[f+3]},{r:e[f],g:e[f+1],b:e[f+2],a:e[f+3]});e[f]=g.r;e[f+1]=g.g;e[f+2]=g.b;e[f+3]=g.a}}},multiply:function(c){this.apply(c,function(a,b){return{r:y((a.r*b.r)/255),g:y((a.g*b.g)/255),b:y((a.b*b.b)/255),a:b.a}});return this},screen:function(c){this.apply(c,function(a,b){return{r:y(255-(((255-a.r)*(255-b.r))/255)),g:y(255-(((255-a.g)*(255-b.g))/255)),b:y(255-(((255-a.b)*(255-b.b))/255)),a:b.a}});return this},overlay:function(c){function calc(b,t){return(b>128)?255-2*(255-t)*(255-b)/255:(b*t*2)/255}this.apply(c,function(a,b){return{r:y(calc(b.r,a.r)),g:y(calc(b.g,a.g)),b:y(calc(b.b,a.b)),a:b.a}});return this},difference:function(c){this.apply(c,function(a,b){return{r:y(Math.abs(a.r-b.r)),g:y(Math.abs(a.g-b.g)),b:y(Math.abs(a.b-b.b)),a:b.a}});return this},addition:function(c){this.apply(c,function(a,b){return{r:y(a.r+b.r),g:y(a.g+b.g),b:y(a.b+b.b),a:b.a}});return this},exclusion:function(c){this.apply(c,function(a,b){return{r:y(128-2*(b.r-128)*(a.r-128)/255),g:y(128-2*(b.g-128)*(a.g-128)/255),b:y(128-2*(b.b-128)*(a.b-128)/255),a:b.a}});return this},softLight:function(c){function calc(b,t){return(b>128)?255-((255-b)*(255-(t-128)))/255:(b*(t+128))/255}this.apply(c,function(a,b){return{r:y(calc(b.r,a.r)),g:y(calc(b.g,a.g)),b:y(calc(b.b,a.b)),a:b.a}});return this}}};var filtrr=new function(){var h=function(a){return(typeof a==="string")||(!isNaN(a))||(a.substring)};var i=function(a){var b=0;var c=0;if(a.offsetParent){while(true){c+=a.offsetTop;b+=a.offsetLeft;if(!a.offsetParent){break}a=a.offsetParent}}else{if(a.x){b+=a.x}if(a.y){c+=a.y}}return{top:c,left:b}}this.img=function(d,e){var f=(h(d))?document.getElementById(d):d;if(f){var g=new Image();g.onload=function(){var a=document.createElement("canvas");a.width=g.width;a.height=g.height;a.getContext("2d").drawImage(g,0,0);var b=i(f);var c=i(f.offsetParent);a.style.top=Math.abs(b.top-c.top)+"px";a.style.left=Math.abs(b.left-c.left)+"px";a.style.position="absolute";if(f.offsetParent){f.offsetParent.appendChild(a);f.style.display="none"}g=null;f=null;e(new filtr(a))};g.src=f.getAttribute("src")}else{throw"Could not find image element with id: "+id;}};this.canvas=function(a,b){var c=(h(a))?document.getElementById(a):a;if(c){b(new filtr(c))}else{throw"Could not find element with id: "+id;}}};